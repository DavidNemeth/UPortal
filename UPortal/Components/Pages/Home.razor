@page "/"
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.FluentUI.AspNetCore.Components.Icons
@using UPortal.Components.Features.ExternalApplications
@using UPortal.Data.Models
@using UPortal.Dtos
@inject IDialogService DialogService
@inject IExternalApplicationService ExternalAppService
@inject IToastService ToastService
@inject NavigationManager NavigationManager

<PageTitle>Home</PageTitle>

<h1>External Applications Dashboard</h1>

@if (isAddAppDialogVisible)
{
    <FluentDialog TrapFocus="true" Modal="true" PreventScroll="true">
        <AddExternalApplicationForm ApplicationModel="newApp" OnSave="HandleSaveExternalApp" OnCancel="HandleCancelAddApp" />
    </FluentDialog>
}

@if (_applications == null)
{
    <p><em>Loading applications...</em></p>
    <FluentProgressRing />
}
else if (!_applications.Any())
{
    <p>No external applications have been added yet. Click the "Add Application" button to get started.</p>
}
else
{
    <FluentGrid Spacing="3">
        @foreach (var app in _applications)
        {
            <FluentGridItem xs="12" sm="6" md="4" lg="3">
                <div style="position: relative;">

                    <FluentButton IconStart="@(new Icons.Regular.Size16.Delete())"
                                  Appearance="Appearance.Lightweight"
                                  OnClick="@(() => OpenDeleteConfirmationDialogAsync(app))"
                                  Style="position: absolute; top: 5px; right: 5px; z-index: 1; --button-icon-size: 16px; padding: 4px; min-width: auto;"
                                  Title="Delete Application" />
                    <FluentCard Height="120px" @onclick="@(() => NavigateToAppView(app.Id))" class="fluent-card">
                        <FluentIcon Value="@(GetIconInstance(app.IconName))" class="fluent-icon" />
                        <div style="margin-top: 10px;font-weight: 600;">
                            @app.AppName
                        </div>
                    </FluentCard>
                </div>
            </FluentGridItem>
        }
    </FluentGrid>
}

<div style="position: fixed; bottom: 60px; right: 20px; z-index: 1000;">
    <FluentButton IconStart="@(new Icons.Regular.Size24.Add())"
                  Appearance="Appearance.Accent"
                  OnClick="OpenAddAppDialog"
                  Title="Add External Application" />
</div>

@code {
    private List<ExternalApplicationDto> _applications;
    private bool isAddAppDialogVisible = false;
    private ExternalApplicationDto newApp = new ExternalApplicationDto();

    protected override async Task OnInitializedAsync()
    {
        await LoadApplicationsAsync();
    }

    private void NavigateToAppView(int appId)
    {
        NavigationManager.NavigateTo($"/app/{appId}");
    }

    private async Task LoadApplicationsAsync()
    {
        _applications = await ExternalAppService.GetAllAsync();
        StateHasChanged();
    }

    /// <summary>
    /// Opens the dialog to add a new external application.
    /// Resets the <see cref="newApp"/> model to ensure a clean form.
    /// </summary>
    private void OpenAddAppDialog()
    {
        newApp = new ExternalApplicationDto(); // Reset model for new entry
        isAddAppDialogVisible = true;
    }

    /// <summary>
    /// Handles the saving of a new external application.
    /// Adds the application via the <see cref="ExternalAppService"/> and updates the UI.
    /// Shows toast notifications for success or failure.
    /// </summary>
    /// <param name="appFromForm">The external application model from the submitted form.</param>
    private async Task HandleSaveExternalApp(ExternalApplicationDto appFromForm)
    {
        try
        {
            await ExternalAppService.AddAsync(appFromForm);

            isAddAppDialogVisible = false;
            await LoadApplicationsAsync();
            ToastService.ShowSuccess($"Application '{appFromForm.AppName}' added successfully!", 5000);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving external application: {ex.Message}");
            ToastService.ShowError("Error adding application", 5000);
        }
    }

    /// <summary>
    /// Handles the cancellation of the 'Add External Application' dialog.
    /// </summary>
    private void HandleCancelAddApp()
    {
        isAddAppDialogVisible = false;
    }

    private async Task OpenDeleteConfirmationDialogAsync(ExternalApplicationDto appToDelete)
    {
        var dialog = await DialogService.ShowConfirmationAsync(
            $"Are you sure you want to delete '{appToDelete.AppName}'?",
            "Yes, delete", "No, cancel", "Confirm Deletion");

        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            try
            {
                await ExternalAppService.DeleteAsync(appToDelete.Id);
                ToastService.ShowSuccess("Application deleted successfully.");
                await LoadApplicationsAsync();
            }
            catch (Exception ex)
            {
                ToastService.ShowError($"Failed to delete application: {ex.Message}");
                // Log the exception ex
            }
        }
    }

    // Basic icon instance resolver (can be expanded or moved to a helper class)
    private Icon GetIconInstance(string iconFullName)
    {
        if (string.IsNullOrEmpty(iconFullName)) return new Icons.Regular.Size32.Question();

        return iconFullName switch
        {
            "Home" => new Icons.Regular.Size32.Home(),
            "AppFolder" => new Icons.Regular.Size32.AppFolder(),
            "Link" => new Icons.Regular.Size32.Link(),
            "Globe" => new Icons.Regular.Size32.Globe(),
            "Settings" => new Icons.Regular.Size32.Settings(),
            "Mail" => new Icons.Regular.Size32.Mail(),
            "CalendarLtr" => new Icons.Regular.Size32.CalendarLtr(),
            "Document" => new Icons.Regular.Size32.Document(),
            "Heart" => new Icons.Regular.Size32.Heart(),
            "Star" => new Icons.Regular.Size32.Star(),
            _ => new Icons.Regular.Size32.Question(), // Default for unknown icons
        };
    }
}